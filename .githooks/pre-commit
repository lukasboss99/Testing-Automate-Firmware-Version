#!/bin/bash
# =============================================================================
# Pre-Commit Hook: Auto-Increment Patch Version
# =============================================================================
# This hook automatically increments the patch number in the VERSION file
# on every commit. The VERSION file is the single source of truth for the
# project version.
#
# Setup (run once per clone):
#   git config core.hooksPath .githooks
#
# To skip auto-increment for a single commit:
#   git commit --no-verify
# =============================================================================

REPO_ROOT="$(git rev-parse --show-toplevel)"
VERSION_FILE="$REPO_ROOT/VERSION"

# Create VERSION file if it doesn't exist
if [ ! -f "$VERSION_FILE" ]; then
    echo "0.0.1" > "$VERSION_FILE"
    echo "[version-hook] Created VERSION file with 0.0.1"
fi

# Check if there are actual staged changes (excluding VERSION itself)
STAGED_CHANGES=$(git diff --cached --name-only | grep -v "^VERSION$")
if [ -z "$STAGED_CHANGES" ]; then
    # Only VERSION is staged or nothing is staged â€” don't increment
    exit 0
fi

# Read current version
VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')

# Parse version components
MAJOR=$(echo "$VERSION" | cut -d. -f1)
MINOR=$(echo "$VERSION" | cut -d. -f2)
PATCH=$(echo "$VERSION" | cut -d. -f3)

# Validate version components
if ! [[ "$MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$MINOR" =~ ^[0-9]+$ ]] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
    echo "[version-hook] ERROR: Invalid version format in VERSION file: '$VERSION'"
    echo "[version-hook] Expected format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
    exit 1
fi

# Increment patch version
PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$PATCH"

# Write new version
echo "$NEW_VERSION" > "$VERSION_FILE"

# Stage the updated VERSION file
git add "$VERSION_FILE"

echo "[version-hook] Version: $VERSION -> $NEW_VERSION"
